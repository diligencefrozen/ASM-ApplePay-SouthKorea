<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>애플페이 가맹점 찾기 - 모바일</title>
    <link rel="stylesheet" href="mobile.css">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d51b1a671a08a16ab1a8b8b139507d1c&libraries=services"></script>
</head>
<body>
    <!-- 지도 영역 -->
    <div id="map" style="width: 100%; height: 80vh;"></div>

    <!-- 광고 배너 -->
    <div id="ad-banner">
        <a href="https://github.com/diligencefrozen" target="_blank">
            <img src="https://via.placeholder.com/728x90" alt="광고 배너">
        </a>
    </div>

    <!-- 검색 창 -->
    <div id="search-box">
        <input type="text" id="search-input" placeholder="장소를 검색하세요.">
        <button id="search-submit">검색</button>
    </div>

    <!-- 현재 위치 버튼 -->
    <div id="current-location">
        <button id="current-location-btn">내 위치</button>
    </div>
    
    <!-- 패치노트 영역이나 모바일 버전에서는 필독사항 영역으로 대체. -->
    <div id="patch-notes">
        <button id="patch-notes-toggle">📌필독사항</button>
        <div id="patch-notes-content">
            <h3>📌필독사항</h3>
            <span style="display: block; margin-bottom: 10px; color: #999; font-weight: bold;">📅 Last Update: 11/02/2024 23:43 KST</span>
            <span style="display: block; margin-bottom: 10px;"><b>📍 내 위치 버튼:</b> 현재 위치로 지도를 이동합니다.</span>
            <span style="display: block; margin-bottom: 10px;">🍎 <b>iPhone 사용자는</b> <a href="https://apps.apple.com/kr/app/%EB%84%A4%EC%9D%B4%EB%B2%84-naver/id393499958" style="color: #007aff;">네이버 앱</a>을 사용하세요.</span>
            <span style="display: block; margin-bottom: 10px;">🍎 <b>iPad 및 Mac 사용자는</b> <a href="https://www.google.com/chrome/" style="color: #007aff;">Chrome</a>을 사용하세요.</span>
            <span style="display: block; margin-bottom: 10px;">⚠️ <b>주의:</b> 동일 건물 내의 매장은 동일 장소로 분류될 수 있습니다.</span>
            <span style="display: block; margin-bottom: 10px;">⭐ <b>가맹점 데이터 출처:</b> <a href="https://www.hyundaicard.com/cpu/ug/CPUUG4001_02.hc?tabindex=1" style="color: #007aff;">현대카드 애플페이 문서</a></span>
        </div>
    </div>    

    <!-- 불러오기 버튼 -->
    <div id="load-stores">
        <button id="load-button">🔍 가맹점 불러오기</button>
    </div>

    <script>
        let map;

        document.addEventListener("DOMContentLoaded", function () {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.34487430629196, 127.93071437137233),
                level: 3,
            };
            map = new kakao.maps.Map(container, options);

            document.getElementById("load-button").addEventListener("click", loadAllStoresAsync);
            document.getElementById("search-submit").addEventListener("click", searchPlaces);
            document.getElementById("current-location-btn").addEventListener("click", moveToCurrentLocation);
        });

        const stores = [
            { keyword: "GS25", imageUrl: "https://github.com/diligencefrozen/applepay-southkorea-map/blob/main/logo/conveniencestore.png?raw=true" },
            { keyword: "CU", imageUrl: "https://github.com/diligencefrozen/applepay-southkorea-map/blob/main/logo/conveniencestore.png?raw=true" },
            { keyword: "스타벅스", imageUrl: "https://github.com/diligencefrozen/applepay-southkorea-map/blob/main/logo/cafe.png?raw=true" },
            { keyword: "롯데백화점", imageUrl: "https://github.com/diligencefrozen/applepay-southkorea-map/blob/main/logo/departmentstore.png?raw=true" },
            { keyword: "코스트코", imageUrl: "https://github.com/diligencefrozen/applepay-southkorea-map/blob/main/logo/mart.png?raw=true" },
        ];

        function createMarkerImage(url) {
            return new kakao.maps.MarkerImage(url, new kakao.maps.Size(24, 35));
        }

        function displayMarker(place, markerImage) {
            if (!place || !place.y || !place.x) return;

            const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(place.y, place.x),
                image: markerImage,
            });
            marker.setMap(map);
        }
        
        async function loadAllStoresAsync() {
            const loadingIndicator = document.createElement("div");
            loadingIndicator.innerText = "가맹점을 불러오는 중...";
            loadingIndicator.style.position = "absolute";
            loadingIndicator.style.top = "10px";
            loadingIndicator.style.left = "50%";
            loadingIndicator.style.transform = "translateX(-50%)";
            loadingIndicator.style.backgroundColor = "rgba(255, 255, 255, 0.8)";
            loadingIndicator.style.padding = "10px";
            loadingIndicator.style.borderRadius = "8px";
            document.body.appendChild(loadingIndicator);
            
            try {
                const placesService = new kakao.maps.services.Places();
                
                for (const store of stores) {
                    await new Promise(resolve => {
                        placesService.keywordSearch(store.keyword, function (data, status) {
                            if (status === kakao.maps.services.Status.OK) {
                                data.forEach(place => {
                                    displayMarker(place, createMarkerImage(store.imageUrl));
                                });
                            } else {
                                console.warn(`검색 실패: ${store.keyword}, 상태: ${status}`);
                            }
                            resolve();
                        });
                    });
                    await new Promise(resolve => setTimeout(resolve, 200)); // 대기 시간
                }
            } finally {
                document.body.removeChild(loadingIndicator);
            }
        }

        
        function moveToCurrentLocation() {
            if (!navigator.geolocation) {
                alert("GPS를 지원하지 않는 브라우저입니다.");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const newPosition = new kakao.maps.LatLng(lat, lng);
                    
                    map.setCenter(newPosition);
                    const marker = new kakao.maps.Marker({ position: newPosition });
                    marker.setMap(map);
                },
                
                function (error) {
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            alert("위치 정보 접근이 거부되었습니다.");
                            break;
                        case error.POSITION_UNAVAILABLE:
                            alert("위치 정보를 사용할 수 없습니다.");
                            break;
                        case error.TIMEOUT:
                            alert("위치 요청 시간이 초과되었습니다.");
                            break;
                        default:
                            alert("알 수 없는 오류가 발생했습니다.");
                    }
                }
            );
        }



        function searchPlaces() {
            const keyword = document.getElementById("search-input").value.trim();
            if (!keyword) {
                alert("검색어를 입력해주세요.");
                return;
            }

            const placesService = new kakao.maps.services.Places();
            placesService.keywordSearch(keyword, function (data, status) {
                if (status === kakao.maps.services.Status.OK) {
                    map.setCenter(new kakao.maps.LatLng(data[0].y, data[0].x));
                } else {
                    alert("검색 결과가 없습니다.");
                }
            });
        }

        function moveToCurrentLocation() {
            if (!navigator.geolocation) {
                alert("GPS를 지원하지 않는 브라우저입니다.");
                return;
            }

            navigator.geolocation.getCurrentPosition(function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const newPosition = new kakao.maps.LatLng(lat, lng);

                map.setCenter(newPosition);
                const marker = new kakao.maps.Marker({ position: newPosition });
                marker.setMap(map);
            }, function () {
                alert("위치를 가져오는데 실패했습니다.");
            });
        }
    </script>
</body>
</html>
